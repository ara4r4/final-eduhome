<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>EduHome Admin - Users</title>

<link rel="stylesheet" href="../assets/css/dashboard.css">
<link rel="shortcut icon" href="../assets/images/favicon.svg" type="image/svg+xml">

<style>
  .chart-container {
    max-width: 600px;
    margin: 0 auto;
  }

  .chart {
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  .dashboard {
  display: flex;
  flex-wrap: wrap;
}

.widget {
  flex: 1 1 calc(33.33% - 20px);
  margin: 10px;
 
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.widget:hover{
  transform: scale(1.05);
  transition: .5s;
}

.widget-header {
  display: flex;
  align-items: center;
  background-color: #f5f5f5;
  padding: 10px;
  border-bottom: 1px solid #ccc;
}

.widget-header {
  display: flex;
  align-items: center;
  background-color: #f5f5f5;
  padding: 10px;
  border-bottom: 1px solid #ccc;
}

.widget-header h2 {
  flex-grow: 1; /* This will make the h2 element take up all the available space */
}

.widget-icon {
  margin-left: auto; /* This will push the .widget-icon to the right */
}

.widget-content {
  padding: 20px;
  color: white;
  background-color: rgba(21, 30, 47,1);
}
.widget-icon{
  text-align: right;
}

@media screen and (max-width: 767px) {
  .widget {
    flex: 1 1 calc(50% - 20px);
  }
}

@media screen and (max-width: 479px) {
  .widget {
    flex: 1 1 100%;
  }
}
</style>
<style>
 
    #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          
            background-color: transparent;
        }

         #questions-table {
    background-color: transparent;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: auto; /* Change width to auto */
    box-sizing: border-box;
    margin-bottom: 20px;
    min-width: 300px; /* Set a minimum width if needed */
}
th, td {
    border: 1px solid transparent;
    padding: 8px 16px;
    border-color: transparent;
    text-align: center;
    max-width: 200px; /* Adjust the value as needed */
    word-wrap: break-word;
    white-space: normal;
}
#questions-table, #add-question {
    background-color: transparent;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 100%; /* Change width to auto */
    box-sizing: border-box;
    min-width: 600px; /* Set a minimum width if needed */
}
        label {
            font-weight: bold;
        }

        input, select {
            width: calc(100% - 10px);
           
            margin-bottom: 15px;
            box-sizing: border-box;
           
            border-radius: 5px;
          
            height: 30px;
            background-color: #101827;
          color: white;
         border-color: transparent;
           
        }
        

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        #table-container {
            overflow-x:scroll;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px; /* Adding border-radius */
            overflow: hidden; /* To hide sharp edges */
        }

        th, td {
            border: 1px solid transparent;
            padding: 8px 16px;
            border-color: transparent;
            text-align: center;
        }

        th:hover, td:hover{
            cursor: pointer;
        }

        th {
            background-color: #1d283c; /* Dark color for the header */
            color: white;
        }

        /* Add striped row styles */
        tbody tr:nth-child(odd) {
            background-color: transparent;
        }
        tbody{
          color: white;
        }
        tbody tr:nth-child(even){
            background-color: transparent;
        }
        select{
          color: white;

        }
        .correct{
          color: lightgreen;
        }
        tbody tr:hover {
    background-color: #1d283c; /* Change to your desired hover color */
}
.popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #1d283c;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 9999; /* Add this line */
}

.popup-content {
    text-align: center;
}

.popup button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
.editinput input{
  width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid #1d283c;
            border-radius: 5px;
            background-color: #101827;
            color: white;
}
label{
  color: white;
}
</style>
</head>
<body>
<!-- partial:index.partial.html -->
<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="app-icon">
       <img src="/public/assets/images/eduhome.png" alt="" style="width: 100px;  display: block;
       margin-left: auto;
       margin-right: auto;
       width: 50%;">
      </div>
    </div>
    <ul class="sidebar-list">
      <li class="sidebar-list-item ">
        <a href="./home.html">
          <ion-icon name="home"></ion-icon>
          <span>Home</span>
        </a>
      </li>
      <li class="sidebar-list-item ">
        <a href="./create-user.html">
          <ion-icon name="person-add"></ion-icon>
          <span>Create Users</span>
        </a>
      </li>
      <li class="sidebar-list-item active">
        <a href="./users.html">
          <ion-icon name="people"></ion-icon>
          <span>Users</span>
        </a>
      </li>
     
    </ul>
    <div class="account-info">
      <div class="account-info-picture">
        <img src="../assets/images/user.png" alt="Account">
      </div>
      <div class="account-info-name" id="username"></div>
     
      <div id="usernam1e" ><ion-icon name="log-out-outline" class="log-out-icon" onclick="logout()"></ion-icon></div>
      
      
    </div>
  </div>
  <div class="app-content">
    <div class="app-content-header">
      <h1 class="app-content-headerText">Users</h1>
     
    </div>
    <div class="app-content-actions">
     
      <div class="app-content-actions-wrapper">
        
       
      </div>
    </div>
    <div id="container">
      <div id="questions-table">
        <div id="searchDiv" style="display: flex; align-items: center;">
            <label for="search" style="display: inline-block;" ></label>
            <input type="text" placeholder="Search users" style="display: inline-block;" class="search-bar">
           
            <select name="filter" id="filter" style="width: 20%;">
                <option value="oldtonew">Oldest to Newest</option>
                <option value="newtoold">Newest to Oldest</option>
            </select>
        </div>
        <div id="table-container">
            <table id="names-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Password</th>
                        <th>Role</th>
                        <th>Topic</th>
                        <th>Verified?</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <div id="popup" class="popup">
      <button id="closeButton" class="close-button">X</button>
      <div class="popup-content">
          <button id="editButton">Edit</button>
          <button id="deleteButton">Delete</button>
      </div>
  </div>
  <div id="editForm" class="popup">
    <button id="closeEditButton" class="close-button">X</button>
    <div class="editInput">
      <label for="editUsername">Username</label>
      <input type="text" id="editUsername" placeholder="Username">

      <label for="editEmail">Email</label>
      <input type="text" id="editEmail" placeholder="Email">

      <label for="editPassword">Password</label>
      <input type="text" id="editPassword" placeholder="Password">

      <label for="editRole">Role</label>
      <input type="text" id="editRole" placeholder="Role">

      <label for="editTopic">Topic</label>
      <input type="text" id="editTopic" placeholder="Topic">

      <label for="editVerified">Verified?</label>
      
      <select name="editVerified" id="editVerified">
        <option value="1">Yes</option>
        <option value="2">No</option>
      </select>

      </select>
      <button id="updateButton">Update</button>
    </div>
  </div>

<!-- partial -->

  <script  src="../assets/js/admindashboard.js"></script>
 


 <script>

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
async function getTopic(cookie){
    if(!cookie) return alert("NO COOKIE PROVIDED");
    
    const response = await fetch('/get-topic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ secret: secret, cookie: cookie })
    });
    
    const data = await response.json();
    const username = data.teachingTopic;
    
    return username || null;
}
 </script>
    <script>

        document.addEventListener("DOMContentLoaded", function() {
       
          fetch('/users', {
      method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ secret })
    })
        .then((response) => response.json())
        .then(async (orders) => {
            const table = document.getElementById("names-table");
            const tbody = table.querySelector("tbody");
    
            orders.forEach(order => {
           
              const tr = document.createElement("tr");
              const td1 = document.createElement("td");
              td1.textContent = order.username;
              tr.appendChild(td1);
              const td2 = document.createElement("td");
                td2.textContent = order.email;
                tr.appendChild(td2);
                const td3 = document.createElement("td");
                td3.textContent = order.password;
                tr.appendChild(td3);
                const td4 = document.createElement("td");
                td4.textContent = order.role;
                tr.appendChild(td4);
            



                const td5 = document.createElement("td");
                td5.textContent = order.teachingTopic;
                tr.appendChild(td5);
                const td7 = document.createElement("td");
                let trueOrFalse = "Yes";
                if(order.email_verified == 2 || order.email_verified ==0) trueOrFalse = "No"
                td7.textContent = trueOrFalse;
                tr.appendChild(td7);
                tbody.appendChild(tr);

                tr.addEventListener("click", () => {
               
                  const popup = document.getElementById('popup');
                  popup.style.display = 'block';
                  const editButton = document.getElementById('editButton');
editButton.addEventListener('click', function() {
    loadUnits(order.unit)
    const editForm = document.getElementById('editForm');
    editForm.style.display = 'block';

    const editUsernameField = document.getElementById('editUsername');
    const editEmailField = document.getElementById('editEmail');
    const editPasswordField = document.getElementById('editPassword');
    const editRoleField = document.getElementById('editRole');
    const editTopicField = document.getElementById('editTopic');
    const editVerifiedField = document.getElementById('editVerified');
 let veri = true;
   if(order.email_verified == 1) veri = true;
   else veri = false;
    editUsernameField.value = order.username;
    editEmailField.value = order.email;
    editPasswordField.value = order.password;
    editRoleField.value = order.role;
    editTopicField.value = order.teachingTopic;
    editVerifiedField.value = order.email_verified;
    
    

    const updateButton = document.getElementById('updateButton');
    updateButton.addEventListener('click', () => {
        const updatedUser = {
            id: order.id,
            username: editUsername.value,
            password: editPassword.value,
            email: editEmail.value,
            role: editRole.value,
            email_verified: Number(editVerified.value),
            teachingTopic: editTopic.value,
            
        };
        if(order.role == "staff" || order.role == "Staff" || order.role == "Admin" || order.role == "admin"){
                alert("You cannot update a staff")
              }else{
        fetch(`/update-user/${updatedUser.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedUser)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
             
                alert("User updated successfully");
                window.location.reload();
            } else {
                alert("Error updating question");
            }
        })
        .catch(error => console.error('Error:', error));
      }
    });
});
            const closeButton = document.getElementById('closeButton');
    closeButton.addEventListener('click', function() {
        const popup = document.getElementById('popup');
        popup.style.display = 'none';
    });

    const deleteButton = document.getElementById('deleteButton');
deleteButton.addEventListener('click', function() {
 
    const confirmation = confirm(`Are you sure you want to delete this user? (${order.username})`);
  
    if (confirmation) {
       
       
     
  
if (order.role == "staff" || order.role == "Staff" || order.role == "Admin" || order.role == "admin") {
    alert("You cannot delete a staff");
}
fetch(`/delete-user/${order.id}`, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ secret: ">#jc=Wer6WkmN9vb<Ue1(363($Griz" })
})
    .then(response => response.json())
    .then(data => {
    
        if (data.message == "User deleted successfully") {
            alert("User Deleted Successfully");
            window.location.reload(); // Reload the page after deletion
        } else {
            alert("Error deleting User");
        }
    })
    .catch(error => console.error('Error:', error));


        
    }else{
      alert("Cancelled")
    }
});

                })
        
            });

            const searchInput = document.querySelector('#searchDiv input');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = tbody.querySelectorAll('tr');

                rows.forEach(row => {
                    const textContent = row.firstElementChild.textContent.toLowerCase();
                    row.style.display = textContent.includes(searchTerm) ? '' : 'none';
                });
            });
        });

    document.getElementById('filter').addEventListener('change', function() {
        const selectedValue = this.value;
        const rows = document.querySelectorAll('#names-table tbody tr');

        if (selectedValue === 'newtoold') {
            const reversedRows = Array.from(rows).reverse();
            document.querySelector('#names-table tbody').innerHTML = '';
            reversedRows.forEach(row => {
                document.querySelector('#names-table tbody').appendChild(row);
            });
        } else if (selectedValue === 'oldtonew') {
            const originalRows = Array.from(rows).reverse();
            document.querySelector('#names-table tbody').innerHTML = '';
            originalRows.forEach(row => {
                document.querySelector('#names-table tbody').appendChild(row);
            });
        }
    });
   
  })

  const closeEditButton = document.getElementById('closeEditButton');
closeEditButton.addEventListener('click', function() {
    const editForm = document.getElementById('editForm');
    editForm.style.display = 'none';
});

    </script>
    <script>
      async function loadUnits(unit){

const cookie = getCookie("EDUHOME-COOKIE")
const topic = await getTopic(cookie)
   fetch('/get-units', {
    method: 'POST',
      headers: {
          'Content-Type': 'application/json'
      },
      body: JSON.stringify({ secret, topic })
  })
      .then((response) => response.json())
      .then(async (units) => {
        units.forEach(unit => {
          const fullName = `${unit.name} ${unit.number}`
          const selectionBox = document.getElementById("editUnit")
          const option = document.createElement("option")
          option.value = fullName
          option.textContent = fullName
          selectionBox.appendChild(option)
        })
          const selectionBox = document.getElementById("editUnit").value = unit
        
        
      })
    }
  
    </script>
      <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
      <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>
</html>
